
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Hotmangay18</title>
  <link rel="icon" href="../assets/logo.svg">
  <style>
    :root{--bg:#0e0f13;--surface:#151823;--text:#e6e7eb;--muted:#a0a6b3;--brand:#7c3aed;--ring:#a855f7}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:10px 0 16px}
    .card{background:#151823;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;margin-bottom:16px}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f121a;color:var(--text);outline:none}
    label{font-size:13px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#1a2030;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--ring);border-color:var(--ring);color:#fff}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 6px;font-size:14px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .notice{background:#1a0b2e;border:1px solid #3b1e63;color:#e2d5ff;padding:10px 12px;border-radius:10px;margin:12px 0}
    @media(max-width:800px){.row,.row3{grid-template-columns:1fr}}
  </style>
<meta name="category" content="asian"/><meta name="category" content="asian"/></head>
<body>
  <div class="container">
    <h1>Admin — Hotmangay18</h1>
    <div class="notice">Đăng nhập bằng token. Bạn có thể đổi token ở dưới hoặc đăng xuất.</div>
    <div class="card flex">
      <input id="tokenInput" placeholder="Nhập/đổi ADMIN_TOKEN..."/>
      <button id="saveToken" class="btn">Lưu token</button>
      <button id="logoutBtn" class="btn right">Đăng xuất</button>
      <span class="badge" id="tokenStatus">Chưa đăng nhập</span>
    </div>

    <div class="card">
      <h3>Thêm / Sửa video</h3>
      <div class="row3">
        <div><label>Tiêu đề</label><input id="title"/></div>
        <div><label>Lượt xem (tự tăng khi xem)</label><input id="views" type="number" min="0" value="0" disabled/></div>
        <div><label>Thời lượng (MM:SS)</label><input id="duration" placeholder="03:21"/></div>
      </div>
      <div class="row">
        <div><label>Thumbnail URL</label><input id="thumbnail" placeholder="/assets/uploads/xxx.jpg hoặc https://..."/></div>
        <div><label>Hoặc tải ảnh thumbnail</label><input id="thumbFile" type="file" accept=".png,.jpg,.jpeg,.webp,.svg"/></div>
      </div>

      <div id="thumbPreviewWrap" style="margin-top:12px">
        <label class="muted">Xem trước thumbnail</label>
        <div style="margin-top:8px;width:100%;max-width:480px;aspect-ratio:16/9;
                    background:#0f121a;border:1px solid rgba(255,255,255,.12);border-radius:10px;
                    display:flex;align-items:center;justify-content:center;overflow:hidden">
          <img id="thumbPreview" alt="Thumbnail preview" style="max-width:100%;max-height:100%;display:none"/>
          <span id="thumbPreviewEmpty" class="muted" style="font-size:13px">Chưa có thumbnail</span>
        </div>
        <div id="thumbNote" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div><label>Embed URL (YouTube/Vimeo/TikTok/...)</label><input id="embedUrl" placeholder="https://..."/></div>
        <div><label>Tags (phân tách bằng dấu phẩy)</label><input id="tags" placeholder="music, live"/></div>
      </div>
      <div><label>Mô tả</label><textarea id="description" rows="4"></textarea></div>
      <div class="flex">
        <button id="submitBtn" class="btn primary">Lưu video</button>
        <button id="resetBtn" class="btn">Reset form</button>
        <span id="formStatus" class="muted right"></span>
      </div>
      <input type="hidden" id="editId" value=""/>
    </div>

    <div class="card">
      <div class="flex">
        <h3 style="margin:0">Danh sách video</h3>
        <button id="refreshBtn" class="btn right">Tải lại</button>
      </div>
      <table class="table">
        <thead><tr><th>ID</th><th>Tiêu đề</th><th>Views</th><th>Thời lượng</th><th>Thumbnail</th><th>Ngày tạo</th><th></th></tr></thead>
        <tbody id="videoRows"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = { token: localStorage.getItem('ADMIN_TOKEN') || '' };
    function auth(){ return state.token? {'Authorization':'Bearer '+state.token} : {}; }
    function setTokenStatus(){ $('tokenStatus').textContent = state.token? 'Đã lưu token' : 'Chưa đăng nhập'; }
    setTokenStatus();
    $('tokenInput').value = state.token;
    $('saveToken').onclick = ()=>{ state.token = $('tokenInput').value.trim(); localStorage.setItem('ADMIN_TOKEN', state.token); setTokenStatus(); };
    $('logoutBtn').onclick = async ()=>{ await fetch('/api/logout',{method:'POST'}); localStorage.removeItem('ADMIN_TOKEN'); location.href='/admin/login.html'; };

    const API = {
      async list(){ const r = await fetch('/api/videos'); if(!r.ok) throw new Error('Load fail'); return r.json(); },
      async upload(file){ const fd=new FormData(); fd.append('file', file); const r = await fetch('/api/upload',{method:'POST', headers:auth(), body:fd}); if(!r.ok) throw new Error('Upload fail'); return r.json(); },
      async createOrUpdate(payload){
        const id = $('editId').value.trim();
        const url = id? `/api/videos/${id}` : '/api/videos';
        const method = id? 'PUT':'POST';
        const r = await fetch(url,{method, headers:{...auth(), 'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('Save fail'); return r.json();
      },
      async remove(id){ const r = await fetch('/api/videos/'+id,{method:'DELETE', headers:auth()}); if(!r.ok) throw new Error('Delete fail'); return r.json(); }
    };

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    function showPreview(url, note){
      const img = $('thumbPreview');
      const empty = $('thumbPreviewEmpty');
      const noteEl = $('thumbNote');
      if(!url){
        img.src = '';
        img.style.display = 'none';
        empty.style.display = 'block';
        noteEl.textContent = '';
        return;
      }
      img.src = url;
      img.style.display = 'block';
      empty.style.display = 'none';
      noteEl.textContent = note || '';
    }
    $('thumbnail').addEventListener('input', debounce(()=>{
      const val = $('thumbnail').value.trim();
      if(val){ showPreview(val, 'Từ Thumbnail URL'); } else { showPreview('', ''); }
    }, 200));
    $('thumbFile').addEventListener('change', ()=>{
      const f = $('thumbFile').files[0];
      if(!f){ showPreview('', ''); return; }
      const objUrl = URL.createObjectURL(f);
      showPreview(objUrl, 'Xem trước file upload (cục bộ)');
    });

    function rowHTML(v){
      const dt = v.createdAt ? new Date(v.createdAt).toLocaleString() : '-';
      return `<tr>
        <td>${v.id}</td>
        <td>${escapeHTML(v.title)}</td>
        <td>${v.views||0}</td>
        <td>${v.duration||''}</td>
        <td><span class="badge">${v.thumbnail}</span></td>
        <td><span class="badge">${dt}</span></td>
        <td class="flex"><button class="btn" data-edit="${v.id}">Sửa</button><button class="btn" data-del="${v.id}">Xoá</button></td>
      </tr>`;
    }
    function escapeHTML(s){return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

    async function loadList(){
      $('videoRows').innerHTML = '<tr><td colspan="7" class="muted">Đang tải...</td></tr>';
      try{
        const list = await API.list();
        $('videoRows').innerHTML = list.map(rowHTML).join('');
        document.querySelectorAll('[data-edit]').forEach(btn=>btn.onclick=()=>fillForm(btn.dataset.edit, list));
        document.querySelectorAll('[data-del]').forEach(btn=>btn.onclick=()=>delVideo(btn.dataset.del));
      }catch(e){
        $('videoRows').innerHTML = '<tr><td colspan="7" class="muted">Lỗi tải dữ liệu</td></tr>';
      }
    }
    $('refreshBtn').onclick = loadList;

    function fillForm(id, list){
      const v = list.find(x=>String(x.id)===String(id)); if(!v) return;
      $('editId').value = v.id; $('title').value = v.title; $('duration').value = v.duration;
      $('thumbnail').value = v.thumbnail; $('embedUrl').value = v.embedUrl; $('description').value = v.description; $('tags').value = (v.tags||[]).join(', ');
      window.scrollTo({top:0, behavior:'smooth'});
      if(v.thumbnail) showPreview(v.thumbnail, 'Từ dữ liệu hiện có'); else showPreview('', '');
    }
    async function delVideo(id){
      if(!confirm('Xoá video #' + id + '?')) return;
      $('formStatus').textContent = 'Đang xoá...';
      try{ await API.remove(id); $('formStatus').textContent = 'Đã xoá'; loadList(); resetForm(); }catch(e){ $('formStatus').textContent = 'Lỗi xoá (kiểm tra token?)'; }
    }
    function resetForm(){ ['editId','title','duration','thumbnail','embedUrl','description','tags','thumbFile'].forEach(id=>{ const el=$(id); if(!el) return; if(el.type==='file') el.value=''; else el.value=''; }); $('formStatus').textContent=''; showPreview('', ''); }
    $('resetBtn').onclick = resetForm;

    $('submitBtn').onclick = async ()=>{
      $('formStatus').textContent = 'Đang lưu...';
      let tn = $('thumbnail').value.trim();
      const file = $('thumbFile').files[0];
      const embed = $('embedUrl').value.trim();
      try{
        if(file){
          const res = await API.upload(file);
          tn = res.path;
        }
        if(!tn) tn = '/assets/thumb.svg';

        const payload = {
          title: $('title').value.trim(),
          duration: $('duration').value.trim(),
          thumbnail: tn,
          embedUrl: embed,
          description: $('description').value.trim(),
          tags: $('tags').value.split(',').map(s=>s.trim()).filter(Boolean)
        };
        await API.createOrUpdate(payload);
        $('formStatus').textContent = 'Đã lưu ✔'; loadList(); resetForm();
      }catch(e){ $('formStatus').textContent = 'Lỗi lưu (kiểm tra token?)'; }
    };

    loadList();
  </script>
</body>
</html>
